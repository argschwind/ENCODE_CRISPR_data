---
title: "Assigning Gasperini guides to CREs"
author: "Andreas Gschwind"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Goal
Gasperini et al., 2019 gRNA sequences were re-mapped using BLAT. Here these are overlapped with
candidate K562 CREs derived from DNase-seq peak summits to assign guides to putative enhancers.

```{r requiredPackages, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(cowplot)
library(GenomicRanges)
library(rtracklayer)
library(knitr)
library(kableExtra)
```

***

## Used data
Re-mapped gRNA coordinates are taken from Joe's analysis. K562 candidate CREs (hg19) were generated
from DNase-seq (ENCFF030DCL) peaks calls using following strategy:

1. Call peaks and summits using MACS2 with very lenient p-value cutoff (0.1)
2. Quantify DNase-seq reads within those peaks
3. Select top 150,000 peaks based on DNase activity (accessibility)
4. Extract summits for those peaks
5. Extend summits by +/- 250bp
6. Merge overlapping summit regions into candidate CREs

```{r loadData}
# file containing re-mapped gRNAs from Joe in a bed-like format
guides_file <- here("resources/Gasperini2019/guide_positions.bed")

# column names in guides_file
guides_col_names <- c("chr", "start", "end", "name", "score", "strand", "spacer")

# load re-mapped gRNAs
guides <- read_tsv(guides_file, col_names = guides_col_names, show_col_types = FALSE)

# file containing DNase-seq peaks with added read counts in a bed-like format
peaks_file <- here("resources/DNase/ENCFF030DCL/ENCFF030DCL_peaks.counts")

# column names in peaks_file
peaks_col_names <- c("chr", "start", "end", "name", "score", "strand", "signalValue", "pValue",
                     "qValue", "peak", "reads")

# load peaks file
peaks <- read_tsv(peaks_file, col_names = peaks_col_names, show_col_types = FALSE)

# bed file containing K562 candidate CREs derived from DNase-seq peak calls
cres_file <- here("resources/DNase/ENCFF030DCL/ENCFF030DCL_candidate_cres.bed")
cres <- import(cres_file, format = "bed")

# load file containing final guide targets including positive controls
guide_targets_file <- here("resources/Gasperini2019/guide_targets.tsv")
guide_targets <- read_tsv(guide_targets_file, show_col_types = FALSE)
```

***

## Candidate CREs
DNase-seq reads in DNase peaks were quantified and are used to assess activtity (accessibility)
within these regions. The top 150,000 regions are selected as candidate regulatory regions. Summits
of those peaks are then extended by 250bp on both sides and merged to create candidate CREs. This
approach is the same as for building ABC candidate enhancers.

```{r, fig.height=4, fig.width=10, dev='png'}
# get unique peaks (if a peak has several summits, it's listed multiple times) and sort by reads
peaks_unique <- peaks %>% 
  select(chr, start, end, reads) %>% 
  distinct() %>% 
  arrange(reads) %>% 
  mutate(peak = seq_len(nrow(.)))

# calculate percent of peaks retained if taking the top 150,000
total_peaks <- nrow(peaks_unique)
perc_retained <- 150000 / total_peaks * 100

# plot DNase reads in peaks distribution
p1 <- ggplot(peaks_unique, aes(x = reads)) +
  geom_histogram(bins = 20) +
  labs(title = paste0("DNase-seq reads in peaks (n=", total_peaks, ")"), x = "read counts") +
  scale_x_log10() +
  theme_bw()

# plot DNase counts per peak
p2 <- ggplot(peaks_unique, aes(x = peak, y = reads)) +
  geom_point(alpha = 0.25) +
  geom_vline(xintercept = nrow(peaks_unique) - 150000, color = "red") +
  labs(title = paste0("DNase-seq reads in peaks (n=", total_peaks, ")"), x = "peaks", y = "read counts") +
  theme_bw()

plot_grid(p1, p2, nrow = 1)
```

By selecting the top 150,000 peaks based on DNase-seq reads (`r round(perc_retained, digits = 1)`%)
of all peaks are retained as candidate regions to create candidate CREs.

After extracting peak summits, estending them by +/- 250bp and merging overlapping summit regions,
a total of `r length(cres)` candidate CREs are generated.

```{r, fig.height=3.5, fig.width=5}
# plot size distribution of merged CREs
cres %>% 
  width() %>% 
  as_tibble() %>%
  ggplot(., aes(value)) +
    geom_histogram(bins = 30) +
    labs(title = "Candidate CREs based on summits +/- 250bp", x = "size (bp)") +
    theme_bw()
```

***

## Overlap Gasperini guides with candidate CREs
Re-mapped Gasperini et al. guides are overlapped with created candidate CREs to assess how these 
perform to assign guides to perturbed elements.

```{r, fig.height=3.5, fig.width=5}
# create GRanges object from guide coordinates
guides_gr <- makeGRangesFromDataFrame(guides, keep.extra.columns = TRUE,
                                      starts.in.df.are.0based = TRUE)

# count the number of overlaps with DNase-seq summits and peaks per guide
n_ovl <- countOverlaps(query = guides_gr, subject = cres, ignore.strand = TRUE) %>% 
  tibble(guide = guides_gr$name, overlaps = .)

# plot the number of overlaps per guide with candidate CREs
ggplot(n_ovl, aes(overlaps)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Number of overlapping CREs per guide") +
  theme_bw()
```

Using the ABC candidate CRE definitions, a total of `r sum(n_ovl$overlaps > 0)` guides
`r round(mean(n_ovl$overlaps > 0) * 100, digits = 1)`% overlap a target candidate CRE.

***

## Assign guides to targets
Guides are assigned to targets using following strategy:

1. Positive TSS targeting control guides are assigned to the respective TSS
2. Any other targeting guides are assigned to overlapping CREs
3. Non-assigned guides are discarded

```{r}
# add column to guide targets identifying positive controls
guide_targets <- guide_targets %>% 
  mutate(target_type = if_else(grepl(target_name, pattern = "^PosCtrl"), true = "tss_ctrl",
                               false = "cre"))

# count the total number of targets and guides for guides targeting CREs and TSS controls
guide_target_stats <- guide_targets %>% 
  group_by(target_type) %>% 
  summarize(targets = n_distinct(target_name), guides = n_distinct(name))

# print table
kable(guide_target_stats) %>% 
  kable_styling(full_width = FALSE)
```

Size distribution and number of guides per targeted CRE.
```{r, fig.height=3, fig.width=8}
# compute size of targeted CREs and number of guides per targeted CRE
cre_targeting_stats <- guide_targets %>% 
  filter(target_type == "cre") %>% 
  group_by(target_name) %>% 
  summarize(size = max(target_end) - min(target_start),
            guides = n_distinct(name))

# extract number of targets and guides for CREs
cre_guide_stats <- filter(guide_target_stats, target_type == "cre")
  
# plot the candidate CRE size distribution and number of targeting guides
p1 <- ggplot(cre_targeting_stats, aes(size)) +
  geom_histogram(binwidth = 100) +
  labs(title = paste0("Target CRE size (", cre_guide_stats$targets, " targets)"), x = "size (bp)") +
  theme_bw()

p2 <- ggplot(cre_targeting_stats, aes(guides)) +
  geom_histogram(binwidth = 1) +
  labs(title = paste0("Guides per target CRE (", cre_guide_stats$guides, " guides)")) +
  theme_bw()

plot_grid(p1, p2, nrow = 1)
```
